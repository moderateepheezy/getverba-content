# Curriculum Export Schema

This document describes the curriculum export artifacts generated by `npm run content:generate-exports`.

## Overview

The export generator produces two artifacts per workspace:
- **JSON export**: Normalized list with full metadata
- **CSV export**: Flattened rows for spreadsheet analysis

Both exports contain the same data, formatted differently for different use cases.

## File Locations

Exports are generated in workspace-scoped directories:

```
content/v1/workspaces/{workspace}/exports/
├── catalog_export.json
└── catalog_export.csv
```

## JSON Export Schema

```json
{
  "version": "v1",
  "generatedAt": "2025-01-15T10:30:00.000Z",
  "workspace": "de",
  "total": 45,
  "items": [
    {
      "workspace": "de",
      "sectionId": "context",
      "packId": "shopping_payment_options",
      "scenario": "shopping",
      "register": "neutral",
      "primaryStructure": "verb_position",
      "level": "A1",
      "estimatedMinutes": 15,
      "variationSlots": "subject; verb; object; modifier",
      "drillType": "substitution",
      "cognitiveLoad": "medium",
      "goal": "Practice shopping scenarios at A1 level",
      "whyThisWorks": "Practice shopping scenarios at A1 level Uses shopping vocabulary appropriately",
      "page": 1,
      "position": 3
    }
  ]
}
```

### Fields

| Field | Type | Description |
|-------|------|-------------|
| `workspace` | string | Workspace ID (e.g., "de") |
| `sectionId` | string | Section ID (e.g., "context", "mechanics", "exams") |
| `packId` | string | Pack/exam/drill ID |
| `scenario` | string | Scenario identifier (e.g., "shopping", "work") |
| `register` | string | Register ("formal", "neutral", "informal", "casual") |
| `primaryStructure` | string | Primary grammatical structure focus |
| `level` | string | CEFR level (A1, A2, B1, B2, C1, C2) |
| `estimatedMinutes` | number | Estimated duration in minutes |
| `variationSlots` | string | Semicolon-separated list of variation slots |
| `drillType` | string | Drill type ("substitution", "pattern-switch", "roleplay-bounded") |
| `cognitiveLoad` | string | Cognitive load ("low", "medium", "high") |
| `goal` | string | Analytics goal (short description) |
| `whyThisWorks` | string | Index summary of why this pack works (goal + first success criterion) |
| `page` | number | Page number in paginated section index (1-indexed) |
| `position` | number | Position within page (1-indexed) |

## CSV Export Schema

The CSV export uses the same fields as JSON, with headers:

```csv
workspace,sectionId,packId,scenario,register,primaryStructure,level,estimatedMinutes,variationSlots,drillType,cognitiveLoad,goal,whyThisWorks,page,position
de,context,shopping_payment_options,shopping,neutral,verb_position,A1,15,"subject; verb; object; modifier",substitution,medium,"Practice shopping scenarios at A1 level","Practice shopping scenarios at A1 level Uses shopping vocabulary appropriately",1,3
```

### CSV Formatting

- **Headers**: First row contains field names
- **Quoting**: Fields containing commas, quotes, or newlines are wrapped in double quotes
- **Escape**: Quotes within quoted fields are escaped as `""`
- **Sorting**: Rows are sorted by `sectionId`, then `page`, then `position`

## Usage

### Generate Exports

```bash
# Generate exports for all workspaces
npm run content:generate-exports

# Generate exports for specific workspace
npm run content:generate-exports -- --workspace de
```

### Access Exports

Exports are static files published to R2 under:

```
/v1/workspaces/{workspace}/exports/catalog_export.json
/v1/workspaces/{workspace}/exports/catalog_export.csv
```

### Example: Load JSON Export

```typescript
const response = await fetch('https://api.example.com/v1/workspaces/de/exports/catalog_export.json');
const export = await response.json();

console.log(`Total items: ${export.total}`);
export.items.forEach(item => {
  console.log(`${item.packId}: ${item.scenario} (${item.level})`);
});
```

### Example: Load CSV Export

```typescript
const response = await fetch('https://api.example.com/v1/workspaces/de/exports/catalog_export.csv');
const csv = await response.text();
const rows = csv.split('\n').slice(1); // Skip header

rows.forEach(row => {
  const [workspace, sectionId, packId, ...rest] = row.split(',');
  console.log(`${packId} in ${sectionId}`);
});
```

## Pagination Position

The `page` and `position` fields indicate where each item appears in the paginated section index:

- **Page**: Page number in the pagination chain (1 = first page, 2 = second page, etc.)
- **Position**: 1-indexed position within that page

Example:
- `page: 1, position: 3` = Third item on the first page
- `page: 2, position: 1` = First item on the second page

This allows you to:
- Track item ordering across pagination boundaries
- Reconstruct the full section index order
- Debug pagination issues

## whyThisWorks Field

The `whyThisWorks` field is generated from:
1. Index item's `whyThisWorks` field (if present in section index)
2. Fallback: `analytics.goal + " " + analytics.successCriteria[0]` (if available)
3. Fallback: `analytics.goal` (if available)
4. Empty string (if no analytics)

This provides a concise summary of why the pack is pedagogically effective.

## Integration with Review Harness

The export generator runs automatically during promotion (`./scripts/promote-staging.sh`), after:
1. Content validation
2. Quality gates
3. Review harness

This ensures exports are always up-to-date with promoted content.

## Smoke Test Validation

The smoke test (`./scripts/smoke-test-content.sh`) validates exports:
- JSON export exists and parses correctly
- CSV export exists and has headers
- Export total matches section index totals

## Use Cases

### B2B Curriculum Sharing

Export CSV to share curriculum structure with partners:

```bash
# Generate exports
npm run content:generate-exports

# Share CSV
cat content/v1/workspaces/de/exports/catalog_export.csv
```

### Analytics Dashboard

Load JSON export to build analytics dashboards:

```typescript
const export = await loadExport('de');
const byLevel = groupBy(export.items, 'level');
const byScenario = groupBy(export.items, 'scenario');
```

### Content Audit

Use CSV export in spreadsheet tools to:
- Filter by level, scenario, register
- Sort by estimatedMinutes
- Count items per section
- Identify gaps in coverage

## B2B Curriculum Export

For sharing curriculum with schools, employers, or immigration tutors, use the B2B curriculum export:

```bash
# Export curriculum for a workspace
npm run content:export -- --workspace de --out exports/

# Export with ZIP bundle
npm run content:export -- --workspace de --out exports/ --zip
```

### Output Structure

The export creates a directory structure:

```
exports/{workspace}/
├── catalog.csv                    # One row per pack
├── packs/
│   ├── {packId}.md               # Teacher pack markdown (one per pack)
│   └── ...
├── snapshot/
│   ├── catalog.json              # Snapshot of catalog
│   └── indexes/
│       ├── {section}.json        # Snapshot of section indexes
│       └── ...
└── meta/
    ├── manifest.json             # Snapshot of manifest
    └── release.json              # Snapshot of release metadata
```

### CSV Schema (B2B Export)

The `catalog.csv` file contains one row per pack with these columns:

| Column | Description |
|--------|-------------|
| `workspace` | Workspace ID (e.g., "de") |
| `sectionId` | Section ID (e.g., "context") |
| `sectionKind` | Section kind (e.g., "context", "mechanics") |
| `packId` | Pack identifier |
| `title` | Pack title |
| `level` | CEFR level (A1, A2, B1, B2, C1, C2) |
| `estimatedMinutes` | Estimated duration |
| `scenario` | Scenario identifier |
| `register` | Register (formal, neutral, informal) |
| `primaryStructure` | Primary grammatical structure |
| `variationSlots` | Pipe-joined variation slots (e.g., "subject\|verb\|object") |
| `goal` | Analytics goal |
| `whyThisWorks` | Pipe-joined whyThisWorks bullets |
| `entryUrl` | Pack entry URL |
| `promptCount` | Number of prompts |
| `stepCount` | Number of session plan steps |

### Pack Markdown Format

Each pack markdown file (`packs/{packId}.md`) includes:

1. **Title** (H1)
2. **Metadata block**: Level, estimated time, scenario, register, primary structure, variation slots, goal
3. **Why This Works**: Bulleted list from analytics
4. **Outline**: Numbered list of outline items
5. **Session Plan**: Steps with prompt IDs
6. **Prompts**: German sentences with optional English gloss, organized by session plan order
7. **Suggested Delivery**: Time box, repetition rule, substitution slots
8. **Footer**: Content version and git SHA (if available)

Example:

```markdown
# Payment and Checkout

## Metadata

- **Level**: A1
- **Estimated Time**: 15 minutes
- **Scenario**: shopping
- **Register**: neutral
- **Primary Structure**: verb_position
- **Variation Slots**: subject, verb, object, modifier
- **Goal**: Practice shopping payment scenarios at A1 level

## Why This Works

- Uses shopping vocabulary appropriately
- Varies subject and verb across prompts
- Maintains neutral register consistency

## Outline

1. Payment Methods
2. Checkout Process
3. Receipts and Discounts

## Session Plan

### Step 1: Payment Methods

**Prompt IDs**: prompt-001, prompt-004, prompt-007

## Prompts

### prompt-001

**German**: Ich zahle 50€ an der Kasse.
**English**: I'm paying 50 euros at the checkout.
**Intent**: inform

## Suggested Delivery

- **Time Box**: 15 minutes
- **Repetition Rule**: Practice each prompt 2-3 times
- **Substitution Slots**: subject, verb, object, modifier

---

*Content Version: v1 | Pack ID: shopping_payment_options*
*Generated from: abc1234*
```

### ZIP Bundle

When using `--zip` flag, the export creates a timestamped ZIP file:

```
exports/{workspace}_{timestamp}_curriculum.zip
```

The ZIP contains the entire export directory structure, making it easy to share with partners.

**Note**: ZIP creation requires the `zip` command to be available on your system. If `zip` is not available, the export will still generate all files in the export directory, but will skip ZIP creation with a warning.

### Validation

The export automatically runs content validation before generating exports. If validation fails, the export is aborted.

### Sharing with Schools/Employers

1. **Generate export**:
   ```bash
   npm run content:export -- --workspace de --out exports/ --zip
   ```

2. **Share the ZIP file** or export directory

3. **Partners can**:
   - Import `catalog.csv` into Google Sheets or Notion
   - Use pack markdown files as teacher guides
   - Reference snapshot files for version traceability

### Deterministic Output

- Exports are deterministic (same input = same output)
- No network calls or LLM usage
- Stable ordering (sections in catalog order, items in index order)
- Fails fast on invalid content

## Related Documentation

- [Rollout Workflow](./ROLLOUT.md) - Promotion workflow including export generation
- [Analytics Metadata](./ANALYTICS_METADATA.md) - Analytics block schema
- [Section Index Pagination](./SECTION_INDEX_PAGINATION.md) - Pagination chain structure

