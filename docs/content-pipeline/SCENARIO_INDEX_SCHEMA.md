# Scenario Index Schema

This document defines the canonical schema for Scenario Index JSON files (`context/scenarios.json`), which enable the Context Library grid UI by grouping packs into scenario categories.

## Schema

```json
{
  "version": 1,
  "kind": "scenario_index",
  "items": [
    {
      "id": "work",
      "title": "Work",
      "subtitle": "Office Greetings · Meeting Phrases · Work Requests",
      "icon": "briefcase",
      "itemCount": 12,
      "itemsUrl": "/v1/workspaces/de/context/work/index.json"
    }
  ]
}
```

## Purpose

The Scenario Index provides a second layer of organization for the Context Library:
- **First layer**: Flat list at `context/index.json` (backward-compatible)
- **Second layer**: Scenario groups at `context/scenarios.json` → scenario-specific paginated indexes

This enables the frontend to render either:
- A simple list (using `context/index.json`)
- A grid of scenario cards (using `context/scenarios.json`)

## Required Fields

### Top Level

- `version` (number): Schema version, currently `1`
- `kind` (string): Must be `"scenario_index"`
- `items` (array): Array of scenario card objects

### Scenario Item Object

Each item in the `items` array must have:

- `id` (string): Scenario identifier (e.g., "work", "travel", "social", "doctor", "housing", "government_office"). Must match scenario IDs used in packs.
- `title` (string): Display title for the scenario (e.g., "Work", "Travel", "Social")
- `subtitle` (string): Descriptive subtitle (e.g., "Office Greetings · Meeting Phrases · Work Requests" or "Common situations")
- `icon` (string): Icon identifier for the scenario card. Valid values: `"briefcase"`, `"airplane"`, `"users"`, `"building"`, `"medical"`, `"home"`, `"utensils"`, `"shopping-cart"`, `"sparkle"` (default)
- `itemCount` (number): Total number of items across all pages in the scenario's paginated index. Must match the actual total.
- `itemsUrl` (string): Canonical URL to the scenario-specific paginated index. Must start with `/v1/` and end with `.json`. Format: `/v1/workspaces/{workspace}/context/{scenario}/index.json`

## Icon Mapping

Icons are deterministically mapped from scenario IDs:

| Scenario ID | Icon |
|------------|------|
| `work` | `briefcase` |
| `travel` | `airplane` |
| `social` | `users` |
| `government_office` | `building` |
| `doctor` | `medical` |
| `housing` | `home` |
| `restaurant` | `utensils` |
| `shopping` | `shopping-cart` |
| (default) | `sparkle` |

## Subtitle Generation

Subtitles are generated deterministically:

1. **From scenario template**: If a scenario template exists at `content/templates/v1/scenarios/{scenarioId}.json`, extract up to 3 step titles from `stepBlueprint[].title` and join with ` · `
2. **Fallback**: If no template exists or stepBlueprint is missing, use `"Common situations"`

## Scenario-Specific Indexes

Each scenario has its own paginated index at:

```
content/v1/workspaces/{workspace}/context/{scenario}/index.json
content/v1/workspaces/{workspace}/context/{scenario}/index.page2.json
...
```

These indexes follow the same schema as regular section indexes (see [SECTION_INDEX_SCHEMA.md](../SECTION_INDEX_SCHEMA.md)):

- `version`: `"v1"`
- `kind`: `"context"` (same as main context index)
- `total`: Total items in this scenario
- `pageSize`: Items per page (default: 12 for scenarios, 20 for main index)
- `items`: Array of pack items filtered by scenario
- `nextPage`: URL to next page or `null`

Each item in a scenario index:
- MUST have a `scenario` field matching the scenario ID
- Includes all standard index item fields: `id`, `kind`, `title`, `level`, `durationMinutes`, `entryUrl`, `scenario`, `register`, `primaryStructure`, `tags`, `analyticsSummary`, etc.

## Validation Rules

The validator enforces:

1. ✅ `version` exists and equals `1`
2. ✅ `kind` exists and equals `"scenario_index"`
3. ✅ `items` exists and is an array
4. ✅ Each item has required fields: `id`, `title`, `subtitle`, `icon`, `itemCount`, `itemsUrl`
5. ✅ `itemsUrl` exists and is accessible
6. ✅ `itemCount` matches the actual total in the scenario's paginated index
7. ✅ No duplicate scenario IDs in `items`
8. ✅ Scenario IDs are known (derived from templates or existing packs)

## Generation

The scenario index is automatically generated by `scripts/generate-indexes.ts`:

1. Scans all packs in `content/v1/workspaces/{workspace}/packs/`
2. Groups packs by `scenario` field
3. For each scenario:
   - Generates paginated index at `context/{scenario}/index.json`
   - Computes `itemCount` from pagination total
   - Generates `title` (capitalize, replace underscores)
   - Generates `subtitle` from template or fallback
   - Maps `icon` from scenario ID
4. Writes `context/scenarios.json` with sorted scenario items

## Backward Compatibility

- The existing `context/index.json` (flat list) is **not removed or changed**
- `catalog.json` sections still point to `/context/index.json` as before
- Frontend can optionally check for `context/scenarios.json` and render grid if present
- If `scenarios.json` doesn't exist, frontend falls back to list rendering

## Example

**Scenario Index** (`context/scenarios.json`):
```json
{
  "version": 1,
  "kind": "scenario_index",
  "items": [
    {
      "id": "work",
      "title": "Work",
      "subtitle": "Office Greetings · Meeting Phrases · Work Requests",
      "icon": "briefcase",
      "itemCount": 8,
      "itemsUrl": "/v1/workspaces/de/context/work/index.json"
    },
    {
      "id": "doctor",
      "title": "Doctor",
      "subtitle": "Making an Appointment · Required Documents · Asking Questions",
      "icon": "medical",
      "itemCount": 16,
      "itemsUrl": "/v1/workspaces/de/context/doctor/index.json"
    }
  ]
}
```

**Scenario-Specific Index** (`context/work/index.json`):
```json
{
  "version": "v1",
  "kind": "context",
  "total": 8,
  "pageSize": 12,
  "items": [
    {
      "id": "work_pack_1_a1",
      "kind": "pack",
      "title": "Work Meetings - A1",
      "level": "A1",
      "durationMinutes": 15,
      "entryUrl": "/v1/workspaces/de/packs/work_pack_1_a1/pack.json",
      "scenario": "work",
      "register": "formal",
      "primaryStructure": "modal_verbs_requests",
      "analyticsSummary": { ... }
    }
  ],
  "nextPage": null
}
```

## Related Documentation

- [SECTION_INDEX_SCHEMA.md](../SECTION_INDEX_SCHEMA.md) - Schema for paginated section indexes
- [PACK_SCHEMA.md](./PACK_SCHEMA.md) - Pack entry schema (includes `scenario` field)
- [TEMPLATE_SCHEMA.md](./TEMPLATE_SCHEMA.md) - Scenario template schema (used for subtitle generation)

