{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Telemetry Event Schema v1",
  "description": "Schema for practice attempt telemetry events",
  "type": "object",
  "required": [
    "schemaVersion",
    "event",
    "timestamp",
    "workspace",
    "userAnonId",
    "content",
    "result",
    "signals"
  ],
  "properties": {
    "schemaVersion": {
      "type": "integer",
      "const": 1,
      "description": "Schema version, must be 1"
    },
    "event": {
      "type": "string",
      "const": "practice_attempt",
      "description": "Event type, must be 'practice_attempt'"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 UTC timestamp"
    },
    "workspace": {
      "type": "string",
      "minLength": 2,
      "maxLength": 10,
      "description": "Workspace code (e.g., 'de', 'en')"
    },
    "userAnonId": {
      "type": "string",
      "minLength": 3,
      "maxLength": 100,
      "description": "Anonymous user identifier (FE responsibility)"
    },
    "content": {
      "type": "object",
      "required": [
        "packId",
        "packVersion",
        "entryUrl",
        "sessionPlanVersion",
        "stepId",
        "promptId",
        "attemptIndex"
      ],
      "properties": {
        "packId": {
          "type": "string",
          "minLength": 1,
          "description": "Pack identifier (matches pack id field)"
        },
        "packVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Pack semantic version (x.y.z format)"
        },
        "entryUrl": {
          "type": "string",
          "pattern": "^/v1/workspaces/[^/]+/packs/[^/]+/pack\\.json$",
          "description": "Canonical entry URL"
        },
        "sessionPlanVersion": {
          "type": "integer",
          "const": 1,
          "description": "Session plan version (must match sessionPlan.version)"
        },
        "stepId": {
          "type": "string",
          "minLength": 1,
          "description": "Step identifier (matches sessionPlan.steps[].id)"
        },
        "promptId": {
          "type": "string",
          "minLength": 1,
          "description": "Prompt identifier (matches prompts[].id)"
        },
        "attemptIndex": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Zero-based attempt index within session"
        }
      },
      "additionalProperties": false
    },
    "result": {
      "type": "object",
      "required": [
        "mode",
        "pass",
        "latencyMs",
        "retryCount"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["speech", "typing"],
          "description": "Input mode: 'speech' or 'typing'"
        },
        "pass": {
          "type": "boolean",
          "description": "Whether the attempt passed validation"
        },
        "latencyMs": {
          "type": "number",
          "minimum": 0,
          "maximum": 60000,
          "description": "Time from prompt display to submission (milliseconds)"
        },
        "asrConfidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "ASR confidence score (0.0-1.0, only for mode: 'speech')"
        },
        "retryCount": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "Number of retries before this attempt"
        }
      },
      "additionalProperties": false
    },
    "signals": {
      "type": "object",
      "required": [
        "scenario",
        "level",
        "primaryStructure",
        "variationSlots"
      ],
      "properties": {
        "scenario": {
          "type": "string",
          "minLength": 1,
          "description": "Content scenario (matches pack scenario field)"
        },
        "level": {
          "type": "string",
          "enum": ["A1", "A2", "B1", "B2", "C1", "C2"],
          "description": "CEFR level (matches pack level field)"
        },
        "primaryStructure": {
          "type": "string",
          "minLength": 1,
          "description": "Primary grammatical structure (matches pack primaryStructure field)"
        },
        "variationSlots": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": ["subject", "verb", "object", "modifier", "tense", "polarity", "time", "location"]
          },
          "description": "Variation slots array (matches pack variationSlots field)"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}

